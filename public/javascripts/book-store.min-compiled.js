"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),dataService={getInstance:function(c){function d(b){B[b._id]=new a(b.title,b.author,b.category,b.imgUrl,b.price,b.pages,b.description)}function e(a){B[a._id]=void 0}function f(a){var b=btoa(y+":"+z),d={Authorization:"Basic "+b};return c.postJSON("https://baas.kinvey.com/user/"+y+"/login",a,d).then(function(a){localStorage.setItem(v,a.username),localStorage.setItem(w,a._kmd.authtoken),localStorage.setItem(x,a._id)})}function g(a){var b=btoa(y+":"+z),d={Authorization:"Basic "+b};return c.postJSON("https://baas.kinvey.com/user/"+y+"/",a,d)}function h(){var a={},b={Authorization:"Kinvey "+localStorage.getItem(w)};return c.postJSON("https://baas.kinvey.com/user/"+y+"/_logout",a,b).then(function(a){console.log(a),localStorage.removeItem(v),localStorage.removeItem(w),localStorage.removeItem(x)})}function i(){return Promise.resolve().then(function(){return!!localStorage.getItem(v)})}function j(){var a={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),a).then(function(a){return a.books})}function k(a){return j().then(function(b){b.push(a);var d={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),d).then(function(a){var e={books:b,username:a.username,address:a.address,phone:a.phone,email:a.email};return c.putJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),e,d)})})}function l(a){return j().then(function(b){for(var d=0;d<b.length;d+=1)if(a._id==b[d]._id){b.splice(d,1);break}var e={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),e).then(function(a){var d={books:b,username:a.username,address:a.address,phone:a.phone,email:a.email};return c.putJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),d,e)})})}function m(){var a={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),a).then(function(b){var d={books:[],username:b.username,address:b.address,phone:b.phone,email:b.email};return c.putJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),d,a)})}function n(a){var b=btoa(y+":"+A),f=a,g={Authorization:"Basic "+b};return d(a),c.postJSON("https://baas.kinvey.com/appdata/"+y+"/booksDataBase",f,g).catch(function(){e(f)})}function o(a,b){var f=btoa(y+":"+A),g={Authorization:"Basic "+f};return d(b),c.putJSON("https://baas.kinvey.com/appdata/"+y+"/booksDataBase/"+a,b,g).catch(function(){e(b)})}function p(){var b=btoa(y+":"+A),d={Authorization:"Basic "+b};return c.getJSON("https://baas.kinvey.com/appdata/"+y+"/booksDataBase",d).then(function(b){return b.forEach(function(b){B[b._id]=new a(b.title,b.author,b.category,b.imgUrl,b.price,b.pages,b.description)}),B})}function q(a){if(B[a])return Promise.resolve(B[a]);var b={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/appdata/"+y+"/booksDataBase/"+a,b).then(function(a){return d(a),a})}function r(a){return j().then(function(b){var d={userId:localStorage.getItem(x),books:b,status:"open",totalPrice:a},e={Authorization:"Kinvey "+localStorage.getItem(w)};return c.postJSON("https://baas.kinvey.com/appdata/"+y+"/orders",d,e)})}function s(){var a={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/appdata/"+y+'/orders/?query={"userId":"'+localStorage.getItem(x)+'"}',a)}function t(){var a={Authorization:"Kinvey "+localStorage.getItem(w)};return c.getJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),a)}function u(a){var b={Authorization:"Kinvey "+localStorage.getItem(w)};return c.putJSON("https://baas.kinvey.com/user/"+y+"/"+localStorage.getItem(x),a,b)}var v="username",w="authKey",x="userID",y="kid_SkGEDPt6",z="1ddc36c888904211906588c736731c4d",A="2c9b407d779742d18a5e4afef9700855",B={};return{login:f,register:g,logout:h,isLoggedIn:i,getCart:j,addToCart:k,removeFromCart:l,createBookInstance:n,updateBookInstance:o,getAllBooks:p,getBookById:q,placeOrder:r,clearCart:m,getCurrentUserData:t,getOrdersByUserId:s,updateUserData:u}}},a=function(){function a(b,c,d,e,f,g,h){_classCallCheck(this,a),this.title=b,this.author=c,this.category=d,this.imgUrl=e,this.price=f,this.pages=g,this.description=h}return _createClass(a,[{key:"title",get:function(){return this._title},set:function(b){this._title=b}},{key:"author",get:function(){return this._author},set:function(b){this._author=b}},{key:"category",get:function(){return this._category},set:function(b){this._category=b}},{key:"imgUrl",get:function(){return this._imgUrl},set:function(b){this._imgUrl=b}},{key:"price",get:function(){return this._price},set:function(b){this._price=b}},{key:"pages",get:function(){return this._pages},set:function(b){this._pages=b}},{key:"description",get:function(){return this._description},set:function(b){this._description=b}}]),a}(),b=function(){function a(b,c,d,e,f,g,h){_classCallCheck(this,a),this.username=b,this.password=c,this.firstName=d,this.lastName=e,this.email=f,this.address=g,this.phoneNumber=h}return _createClass(a,[{key:"_formatInputData",value:function(b){function c(a){return String(a).replace(/[&<>"'\/]/g,function(a){return entityMap[a]})}return b=b.trim(),b=c(b)}},{key:"_validateName",value:function(b){if(/^[^A-Z]/.test(b))throw new Error("Name must begin with a capital letter!");for(var c=1;c<b.length;c+=1){if(/^a-z-/g.test(b[c]))throw new Error("Disallowed characters! A name must begin with a capital letter and continue with lower case latin symbols!");if("-"===b[c-1]&&"-"===b[c])throw new Error("There cannot be two or more successive dashes in a name!")}}},{key:"username",get:function(){return this._username},set:function(b){if(b=_formatInputData(b),/[^A-Za-z0-9-_.]/g.test(b))throw new Error("Username can only contain only latin letters, numbers, dash, underscore or a dot!");this._username=b}},{key:"password",get:function(){return this._password},set:function(b){b=_formatInputData(b),this._password=b}},{key:"firstName",get:function(){return this._firstName},set:function(b){b=_formatInputData(b),_validateName(b),this._firstName=b}},{key:"lastName",get:function(){return this._lastName},set:function(b){b=_formatInputData(b),_validateName(b),this._lastName=b}},{key:"email",get:function(){return this._email},set:function(b){b=_formatInputData(b);var c=/^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/;if(b.match(c).length<1)throw new Error("Invalid email address!");this._email=b}},{key:"address",get:function(){return this._address},set:function(b){b=_formatInputData(b),this._address=b}},{key:"phoneNumber",get:function(){return this._phoneNumber},set:function(b){if(b=_formatInputData(b),/[^0-9]/g.test(b))throw new Error("Invalid telephone number!");this._phoneNumber=b}}]),a}(),c=function(){function b(a,c){_classCallCheck(this,b),this.name=a,this.description=c,this._books=[]}return _createClass(b,[{key:"add",value:function(c){if(!(c instanceof a))throw new Error("Only books can be added.");this.books.push(c)}},{key:"remove",value:function(b){var c=this.books.indexOf(b);if(c<0)throw new Error("Book not found.");this.books.splice(c,1)}},{key:"removeAll",value:function(){this._books=[]}},{key:"name",get:function(){return this._name},set:function(b){if("string"!=typeof b)throw new Error("Name must be a string.");this._name=b}},{key:"description",get:function(){return this._description},set:function(b){if("string"!=typeof b)throw new Error("Description must be a string.");if(b.length<=10&&b.length>50)throw new Error("Description must be between 10 and 50 symbols long.");this._description=b}},{key:"books",get:function(){return this._books},set:function(b){throw new Error("Books cannot be changed.Use add remove or removeAll methods instead.")}}]),b}();"undefined"==typeof window&&(module.exports={Book:a,User:b,Author:c});var d={getInstance:function(b,c,d){function e(a){m.html(a)}function f(){b.isLoggedIn().then(function(a){a?(d("#logged-in").removeClass("hidden"),d("#logged-out").addClass("hidden")):(d("#logged-in").addClass("hidden"),d("#logged-out").removeClass("hidden"))})}function g(){f(),c.compile("products").then(function(a){e(a)}),b.getAllBooks().then(function(a){var b={books:a};return c.compile("products",b)}).then(function(a){e(a)})}function h(a){b.getAllBooks().then(function(b){var d=[],e=decodeURI(a.productName).toLowerCase();for(var f in b)d.push(b[f]),d[d.length-1]._id=f;var g=[],h=!0,i=!1,j=void 0;try{for(var l,k=d[Symbol.iterator]();!(h=(l=k.next()).done);h=!0){var m=l.value;(m.title.toLowerCase().indexOf(e)>0||m.author.toLowerCase().indexOf(e)>0||m.category.toLowerCase().indexOf(e)>0||m.description.toLowerCase().indexOf(e)>0)&&g.push(m)}}catch(a){i=!0,j=a}finally{try{!h&&k.return&&k.return()}finally{if(i)throw j}}console.log(d),console.log(g);var n={searchValue:decodeURI(a.productName)};return g.length>0&&(n.books=g),c.compile("search",n)}).then(function(a){e(a)})}function i(a){b.getAllBooks().then(function(b){var d=[],e=decodeURI(a.category);if("all-categories"==a.category)for(var f in b)d.push(b[f]),d[d.length-1]._id=f;else for(var g in b)b[g].category.toLowerCase()==e.toLowerCase()&&(d.push(b[g]),d[d.length-1]._id=g);var h={};return d.length>0&&(h={books:d}),"all-categories"==a.category?h.sectionCategory="All Categories":h.sectionCategory=e.substr(0,1).toUpperCase()+e.substr(1),c.compile("category",h)}).then(function(a){e(a)})}function j(a){var f=void 0;b.getBookById(a.id).then(function(a){return f=a,a.pageUrl=encodeURIComponent(window.location.href),c.compile("book-instance",a)}).then(function(a){e(a),d("#btn-add-to-cart").on("click",function(){if(!b.isLoggedIn())throw new Error("You must be logged in to add a book to the cart!");b.addToCart(f).then(function(a,b){b||toastr.success("Book added to cart!")}).catch(function(a){toastr.error(a.responseJSON.description+". Please log in!")})})}).catch(function(a){toastr.error(a)})}function k(){c.compile("about").then(function(a){e(a)})}function l(){c.compile("contacts").then(function(a){e(a)})}var m=d("#container");if(m.length<1)throw new Error("No #container found on page!");return f(),{home:g,search:h,categories:i,productById:j,about:k,contacts:l}}};"undefined"==typeof window&&(module.exports=d.getInstance);var e={getInstance:function(b){return{get:function(c){return new Promise(function(a,d){b.ajax({url:c,method:"GET",success:function(c){a(c)},error:function(b){d(b)}})})},putJSON:function(c,d){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(a,f){b.ajax({url:c,headers:e,method:"PUT",contentType:"application/json",data:JSON.stringify(d),success:function(c){a(c)},error:function(b){f(b)}})})},postJSON:function(c,d){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(a,f){b.ajax({url:c,headers:e,method:"POST",contentType:"application/json",data:JSON.stringify(d),success:function(c){a(c)},error:function(b){f(b)}})})},getJSON:function(c){var d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(a,e){b.ajax({url:c,method:"GET",headers:d,contentType:"application/json",success:function(c){a(c)},error:function(b){e(b)}})})}}}};"undefined"==typeof window&&(module.exports=e.getInstance);var f={getInstance:function(b,c){function d(a){if(f[a])return Promise.resolve(f[a]);var c="./templates/"+a+".handlebars";return b.get(c).then(function(b){return f[a]=b,Promise.resolve(b)})}function e(a,b){var e=d(a).then(function(a){var d=c.compile(a);return d(b)});return e}var f={};return{compile:e}}};"undefined"==typeof window&&(module.exports=f);var g={getInstance:function(b,c,d){function e(a){l.html(a)}function f(){b.isLoggedIn().then(function(a){a?(d("#logged-in").removeClass("hidden"),d("#logged-out").addClass("hidden")):(d("#logged-in").addClass("hidden"),d("#logged-out").removeClass("hidden"))})}function g(){var a=0;b.getCart().then(function(b){b.forEach(function(b){a+=b._price});var d={};return b.length>0&&(a=Math.round(100*a)/100,d={books:b,totalPrice:a}),c.compile("cart",d)}).then(function(c){e(c),d(".remove-from-cart").click(function(a){var c=d(a.target).attr("data-book-id");b.getBookById(c).then(function(a){return b.removeFromCart(a)}).then(function(){g()})}),d("#checkout-btn").click(function(c){b.placeOrder(a).then(function(){return toastr.success("Order has been successfully placed!"),b.clearCart()}).then(function(){d(location).attr("href","#/products")}).catch(function(a){toastr.error(a.responseJSON.description)})})})}function h(){c.compile("login").then(function(a){e(a),d("#btn-login").on("click",function(){var a={username:d("#tb-username").val().trim(),password:d("#tb-password").val().trim()};b.login(a).then(function(){toastr.success("User Logged in!"),d(location).attr("href","#/products")}).catch(function(a){toastr.error(a.responseJSON.description),d("#tb-username").val(""),d("#tb-password").val("")})})})}function i(){c.compile("register").then(function(a){e(a),d("#btn-register").on("click",function(){var a={username:d("#tb-username").val(),password:d("#tb-password").val(),email:d("#tb-email").val(),phone:d("#tb-phone").val(),address:d("#tb-address").val(),books:[]};b.register(a).then(function(){console.log("User registered!"),toastr.success("User registered")}).catch(function(a){toastr.error(a.responseJSON.description)})})})}function j(){b.logout().then(function(){toastr.success("User Logged out!"),d(location).attr("href","#/products")})}function k(){var a=void 0,f=void 0;Promise.all([b.getCurrentUserData(),b.getOrdersByUserId()]).then(function(b){return a=b[0],f=b[1],{user:a,orders:f}}).then(function(a){return c.compile("profile",a)}).then(function(c){e(c),d("#submit-user-data").click(function(c){var e=d("#profile-form")[0];e.checkValidity&&!e.checkValidity()||(a.address=d("#user-address-input").val(),a.phone=d("#user-phone-input").val(),console.log(a),b.updateUserData(a).then(function(){d(location).attr("href","#/products"),toastr.success("Your profile information has been updated!")}).catch(function(a){toastr.error(a.responseJSON.description)}))})}).catch(function(a){toastr.error(a.responseJSON.description)})}var l=d("#container");if(l.length<1)throw new Error("No #container found on page!");return f(),{login:h,register:i,logout:j,profile:k,cart:g}}},h=e.getInstance($),i=f.getInstance(h,Handlebars),j=dataService.getInstance(h),k=new Navigo(null,!0),l=g.getInstance(j,i,$),m=d.getInstance(j,i,$);k.on("/products",m.home).on("/login",l.login).on("/register",l.register).on("/logout",l.logout).on("/profile",l.profile).on("/cart",l.cart).on("/search/:productName",m.search).on("/products/:category",m.categories).on("/products/review/:id",m.productById).on("/about",m.about).on("/contacts",m.contacts).on("/home",function(){k.navigate("/products")}).on("/",function(){k.navigate("/products")}).on("",function(){k.navigate("/products")}).resolve(),$("#btn-search").on("click",function(){var a=$("#search-bar"),b=encodeURI(a.val().trim());b&&(k.navigate("/search/"+b),a.val(""))}),toastr.options={closeButton:!0,debug:!1,newestOnTop:!0,progressBar:!1,positionClass:"toast-top-center",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"300",timeOut:"2000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};