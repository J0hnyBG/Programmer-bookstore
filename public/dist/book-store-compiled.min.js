"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Book=function(){function a(b,c,d,e,f,g,h){_classCallCheck(this,a),this.title=b,this.author=c,this.category=d,this.imgUrl=e,this.price=f,this.pages=g,this.description=h}return _createClass(a,[{key:"title",get:function(){return this._title},set:function(b){this._title=b}},{key:"author",get:function(){return this._author},set:function(b){this._author=b}},{key:"category",get:function(){return this._category},set:function(b){this._category=b}},{key:"imgUrl",get:function(){return this._imgUrl},set:function(b){this._imgUrl=b}},{key:"price",get:function(){return this._price},set:function(b){this._price=b}},{key:"pages",get:function(){return this._pages},set:function(b){this._pages=b}},{key:"description",get:function(){return this._description},set:function(b){this._description=b}}]),a}(),User=function(){function a(b,c,d,e,f,g,h){_classCallCheck(this,a),this.username=b,this.password=c,this.firstName=d,this.lastName=e,this.email=f,this.address=g,this.phoneNumber=h}return _createClass(a,[{key:"_formatInputData",value:function(b){function d(a){return String(a).replace(/[&<>"'\/]/g,function(a){return entityMap[a]})}b=b.trim();return b=d(b)}},{key:"_validateName",value:function(b){if(/^[^A-Z]/.test(b))throw new Error("Name must begin with a capital letter!");for(var c=1;c<b.length;c+=1){if(/^a-z-/g.test(b[c]))throw new Error("Disallowed characters! A name must begin with a capital letter and continue with lower case latin symbols!");if("-"===b[c-1]&&"-"===b[c])throw new Error("There cannot be two or more successive dashes in a name!")}}},{key:"username",get:function(){return this._username},set:function(b){if(b=_formatInputData(b),/[^A-Za-z0-9-_.]/g.test(b))throw new Error("Username can only contain only latin letters, numbers, dash, underscore or a dot!");this._username=b}},{key:"password",get:function(){return this._password},set:function(b){b=_formatInputData(b),this._password=b}},{key:"firstName",get:function(){return this._firstName},set:function(b){b=_formatInputData(b),_validateName(b),this._firstName=b}},{key:"lastName",get:function(){return this._lastName},set:function(b){b=_formatInputData(b),_validateName(b),this._lastName=b}},{key:"email",get:function(){return this._email},set:function(b){b=_formatInputData(b);var c=/^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/;if(b.match(c).length<1)throw new Error("Invalid email address!");this._email=b}},{key:"address",get:function(){return this._address},set:function(b){b=_formatInputData(b),this._address=b}},{key:"phoneNumber",get:function(){return this._phoneNumber},set:function(b){if(b=_formatInputData(b),/[^0-9]/g.test(b))throw new Error("Invalid telephone number!");this._phoneNumber=b}}]),a}(),Author=function(){function a(b,c){_classCallCheck(this,a),this.name=b,this.description=c,this._books=[]}return _createClass(a,[{key:"add",value:function(b){if(!(b instanceof Book))throw new Error("Only books can be added.");this.books.push(b)}},{key:"remove",value:function(b){var c=this.books.indexOf(b);if(c<0)throw new Error("Book not found.");this.books.splice(c,1)}},{key:"removeAll",value:function(){this._books=[]}},{key:"name",get:function(){return this._name},set:function(b){if("string"!=typeof b)throw new Error("Name must be a string.");this._name=b}},{key:"description",get:function(){return this._description},set:function(b){if("string"!=typeof b)throw new Error("Description must be a string.");if(b.length<=10&&b.length>50)throw new Error("Description must be between 10 and 50 symbols long.");this._description=b}},{key:"books",get:function(){return this._books},set:function(b){throw new Error("Books cannot be changed.Use add remove or removeAll methods instead.")}}]),a}();"undefined"==typeof window&&(module.exports={Book:Book,User:User,Author:Author});var dataService={getInstance:function(b){function k(a){j[a._id]=new Book(a.title,a.author,a.category,a.imgUrl,a.price,a.pages,a.description)}function m(a){var c=btoa(g+":"+h),i={Authorization:"Basic "+c};return b.postJSON("https://baas.kinvey.com/user/"+g+"/login",a,i).then(function(a){localStorage.setItem(d,a.username),localStorage.setItem(e,a._kmd.authtoken),localStorage.setItem(f,a._id)})}function n(a){var c=btoa(g+":"+h),d={Authorization:"Basic "+c};return b.postJSON("https://baas.kinvey.com/user/"+g+"/",a,d)}function o(){var a={},c={Authorization:"Kinvey "+localStorage.getItem(e)};return b.postJSON("https://baas.kinvey.com/user/"+g+"/_logout",a,c).then(function(a){console.log(a),localStorage.removeItem(d),localStorage.removeItem(e),localStorage.removeItem(f)})}function p(){return Promise.resolve().then(function(){return!!localStorage.getItem(d)})}function q(){var a={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),a).then(function(a){return a.books})}function r(a){return q().then(function(c){c.push(a);var d={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),d).then(function(a){var e={books:c,username:a.username,address:a.address,phone:a.phone,email:a.email};return b.putJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),e,d)})})}function s(a){return q().then(function(c){for(var d=0;d<c.length;d+=1)if(a._id==c[d]._id){c.splice(d,1);break}var h={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),h).then(function(a){var d={books:c,username:a.username,address:a.address,phone:a.phone,email:a.email};return b.putJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),d,h)})})}function t(){var a={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),a).then(function(c){var d={books:[],username:c.username,address:c.address,phone:c.phone,email:c.email};return b.putJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),d,a)})}function u(){var a=btoa(g+":"+i),c={Authorization:"Basic "+a};return b.getJSON("https://baas.kinvey.com/appdata/"+g+"/booksDataBase",c).then(function(a){return a.forEach(function(a){j[a._id]=new Book(a.title,a.author,a.category,a.imgUrl,a.price,a.pages,a.description)}),j})}function v(a){if(j[a])return Promise.resolve(j[a]);var c={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/appdata/"+g+"/booksDataBase/"+a,c).then(function(a){return k(a),a})}function w(a){return q().then(function(c){var d={userId:localStorage.getItem(f),books:c,status:"open",totalPrice:a},h={Authorization:"Kinvey "+localStorage.getItem(e)};return b.postJSON("https://baas.kinvey.com/appdata/"+g+"/orders",d,h)})}function x(){var a={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/appdata/"+g+'/orders/?query={"userId":"'+localStorage.getItem(f)+'"}',a)}function y(){var a={Authorization:"Kinvey "+localStorage.getItem(e)};return b.getJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),a)}function z(a){var c={Authorization:"Kinvey "+localStorage.getItem(e)};return b.putJSON("https://baas.kinvey.com/user/"+g+"/"+localStorage.getItem(f),a,c)}var d="username",e="authKey",f="userID",g="kid_SkGEDPt6",h="1ddc36c888904211906588c736731c4d",i="2c9b407d779742d18a5e4afef9700855",j={};return{login:m,register:n,logout:o,isLoggedIn:p,getCart:q,addToCart:r,removeFromCart:s,getAllBooks:u,getBookById:v,placeOrder:w,clearCart:t,getCurrentUserData:y,getOrdersByUserId:x,updateUserData:z}}},pageController={getInstance:function(b,c,d){function f(a){e.html(a)}function g(){b.isLoggedIn().then(function(a){a?(d("#logged-in").removeClass("hidden"),d("#logged-out").addClass("hidden")):(d("#logged-in").addClass("hidden"),d("#logged-out").removeClass("hidden"))})}function h(){g(),c.compile("products").then(function(a){f(a)}),b.getAllBooks().then(function(a){var b={books:a};return c.compile("products",b)}).then(function(a){f(a)})}function k(a){b.getAllBooks().then(function(b){var d=[],e=decodeURI(a.productName).toLowerCase();for(var f in b)d.push(b[f]),d[d.length-1]._id=f;var g=[],h=!0,i=!1,j=void 0;try{for(var l,k=d[Symbol.iterator]();!(h=(l=k.next()).done);h=!0){var m=l.value;(m.title.toLowerCase().indexOf(e)>0||m.author.toLowerCase().indexOf(e)>0||m.category.toLowerCase().indexOf(e)>0||m.description.toLowerCase().indexOf(e)>0)&&g.push(m)}}catch(a){i=!0,j=a}finally{try{!h&&k.return&&k.return()}finally{if(i)throw j}}console.log(d),console.log(g);var n={searchValue:decodeURI(a.productName)};return g.length>0&&(n.books=g),c.compile("search",n)}).then(function(a){f(a)})}function l(a){b.getAllBooks().then(function(b){var d=[],e=decodeURI(a.category);if("all-categories"==a.category)for(var f in b)d.push(b[f]),d[d.length-1]._id=f;else for(var g in b)b[g].category.toLowerCase()==e.toLowerCase()&&(d.push(b[g]),d[d.length-1]._id=g);var h={};return d.length>0&&(h={books:d}),"all-categories"==a.category?h.sectionCategory="All Categories":h.sectionCategory=e.substr(0,1).toUpperCase()+e.substr(1),c.compile("category",h)}).then(function(a){f(a)})}function m(a){var e=void 0;b.getBookById(a.id).then(function(a){return e=a,a.pageUrl=encodeURIComponent(window.location.href),c.compile("book-instance",a)}).then(function(a){f(a),d("#btn-add-to-cart").on("click",function(){if(!b.isLoggedIn())throw new Error("You must be logged in to add a book to the cart!");b.addToCart(e).then(function(a,b){b||toastr.success("Book added to cart!")}).catch(function(a){toastr.error(a.responseJSON.description+". Please log in!")})})}).catch(function(a){toastr.error(a)})}function n(){c.compile("about").then(function(a){f(a)})}function o(){c.compile("contacts").then(function(a){f(a)})}var e=d("#container");if(e.length<1)throw new Error("No #container found on page!");return g(),{home:h,search:k,categories:l,productById:m,about:n,contacts:o}}};"undefined"==typeof window&&(module.exports=pageController.getInstance);var requester={getInstance:function(b){return{get:function(c){return new Promise(function(a,d){b.ajax({url:c,method:"GET",success:function(c){a(c)},error:function(b){d(b)}})})},putJSON:function(c,d){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(a,f){b.ajax({url:c,headers:e,method:"PUT",contentType:"application/json",data:JSON.stringify(d),success:function(c){a(c)},error:function(b){f(b)}})})},postJSON:function(c,d){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(a,f){b.ajax({url:c,headers:e,method:"POST",contentType:"application/json",data:JSON.stringify(d),success:function(c){a(c)},error:function(b){f(b)}})})},getJSON:function(c){var d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(a,e){b.ajax({url:c,method:"GET",headers:d,contentType:"application/json",success:function(c){a(c)},error:function(b){e(b)}})})}}}};"undefined"==typeof window&&(module.exports=requester.getInstance);var templates={getInstance:function(b,c){function e(a){if(d[a])return Promise.resolve(d[a]);var c="./templates/"+a+".handlebars";return b.get(c).then(function(b){return d[a]=b,Promise.resolve(b)})}function f(a,b){var d=e(a).then(function(a){var d=c.compile(a);return d(b)});return d}var d={};return{compile:f}}};"undefined"==typeof window&&(module.exports=templates);var userController={getInstance:function(b,c,d){function f(a){e.html(a)}function g(){b.isLoggedIn().then(function(a){a?(d("#logged-in").removeClass("hidden"),d("#logged-out").addClass("hidden")):(d("#logged-in").addClass("hidden"),d("#logged-out").removeClass("hidden"))})}function h(){var a=0;b.getCart().then(function(b){b.forEach(function(b){a+=b._price});var d={};return b.length>0&&(a=Math.round(100*a)/100,d={books:b,totalPrice:a}),c.compile("cart",d)}).then(function(c){f(c),d(".remove-from-cart").click(function(a){var c=d(a.target).attr("data-book-id");b.getBookById(c).then(function(a){return b.removeFromCart(a)}).then(function(){h()})}),d("#checkout-btn").click(function(c){b.placeOrder(a).then(function(){return toastr.success("Order has been successfully placed!"),b.clearCart()}).then(function(){d(location).attr("href","#/products")}).catch(function(a){toastr.error(a.responseJSON.description)})})})}function i(){c.compile("login").then(function(a){f(a),d("#btn-login").on("click",function(){var a={username:d("#tb-username").val().trim(),password:d("#tb-password").val().trim()};b.login(a).then(function(){toastr.success("User Logged in!"),d(location).attr("href","#/products")}).catch(function(a){toastr.error(a.responseJSON.description),d("#tb-username").val(""),d("#tb-password").val("")})})})}function j(){c.compile("register").then(function(a){f(a),d("#btn-register").on("click",function(a){if(a.preventDefault(),a.stopPropagation(),!d("#register-form")[0].checkValidity||d("#register-form")[0].checkValidity()){var c={username:d("#tb-username").val(),password:d("#tb-password").val(),email:d("#tb-email").val(),phone:d("#tb-phone").val(),address:d("#tb-address").val(),books:[]};b.register(c).then(function(){toastr.success("User registered!"),d(location).attr("href","#/login")}).catch(function(a){toastr.error(a.responseJSON.description)})}else toastr.error("Please fill out all fields correctly!")})})}function k(){b.logout().then(function(){toastr.success("User Logged out!"),d(location).attr("href","#/products")})}function l(){var a=void 0,e=void 0;Promise.all([b.getCurrentUserData(),b.getOrdersByUserId()]).then(function(b){return a=b[0],e=b[1],{user:a,orders:e}}).then(function(a){return c.compile("profile",a)}).then(function(c){f(c),d("#submit-user-data").click(function(c){var e=d("#profile-form")[0];e.checkValidity&&!e.checkValidity()||(a.address=d("#user-address-input").val(),a.phone=d("#user-phone-input").val(),b.updateUserData(a).then(function(){d(location).attr("href","#/products"),toastr.success("Your profile information has been updated!")}).catch(function(a){toastr.error(a.responseJSON.description)}))})}).catch(function(a){toastr.error(a.responseJSON.description)})}var e=d("#container");if(e.length<1)throw new Error("No #container found on page!");return g(),{login:i,register:j,logout:k,profile:l,cart:h}}},requesterInstance=requester.getInstance($),templateInstance=templates.getInstance(requesterInstance,Handlebars),dataServiceInstance=dataService.getInstance(requesterInstance),router=new Navigo(null,!0),userControllerInstance=userController.getInstance(dataServiceInstance,templateInstance,$),pageControllerInstance=pageController.getInstance(dataServiceInstance,templateInstance,$);router.on("/products",pageControllerInstance.home).on("/login",userControllerInstance.login).on("/register",userControllerInstance.register).on("/logout",userControllerInstance.logout).on("/profile",userControllerInstance.profile).on("/cart",userControllerInstance.cart).on("/search/:productName",pageControllerInstance.search).on("/products/:category",pageControllerInstance.categories).on("/products/review/:id",pageControllerInstance.productById).on("/about",pageControllerInstance.about).on("/contacts",pageControllerInstance.contacts).on("/home",function(){router.navigate("/products")}).on("/",function(){router.navigate("/products")}).on("",function(){router.navigate("/products")}).resolve(),$("#btn-search").on("click",function(){var a=$("#search-bar"),b=encodeURI(a.val().trim());b&&(router.navigate("/search/"+b),a.val(""))}),toastr.options={closeButton:!0,debug:!1,newestOnTop:!0,progressBar:!1,positionClass:"toast-top-center",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"300",timeOut:"2000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"};